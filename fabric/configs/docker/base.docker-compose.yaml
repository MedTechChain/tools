version: '3.8'


services:
  orderer:
    container_name: orderer.${ORG_DOMAIN}
    image: hyperledger/fabric-orderer:${FABRIC_IMAGE_TAG}
    command: orderer
    environment:
      FABRIC_CFG_PATH: /var/hyperledger/config
      FABRIC_LOGGING_SPEC: INFO

      ORDERER_GENERAL_LISTENADDRESS: 0.0.0.0
      ORDERER_GENERAL_BOOTSTRAPMETHOD: file
      ORDERER_GENERAL_BOOTSTRAPFILE: /var/hyperledger/genesis/medtechchain-genesis.block  

      ORDERER_GENERAL_LOCALMSPDIR: /var/hyperledger/msp
      ORDERER_GENERAL_LOCALMSPID: ${ORG_ORDERER_LOCALMSPID}

      ORDERER_GENERAL_TLS_ENABLED: "true"
      ORDERER_GENERAL_TLS_PRIVATEKEY: /var/hyperledger/tls/server.key
      ORDERER_GENERAL_TLS_CERTIFICATE: /var/hyperledger/tls/server.crt
      ORDERER_GENERAL_TLS_ROOTCAS: "[/var/hyperledger/tls/ca.crt]" 
    volumes:
    - ./configs/nodes/orderer.yaml:/var/hyperledger/config/orderer.yaml
    - ./.generated/artifacts/genesis:/var/hyperledger/genesis
    - ./.generated/crypto/ordererOrganizations/${ORG_DOMAIN}/orderers/orderer.${ORG_DOMAIN}/msp:/var/hyperledger/msp
    - ./.generated/crypto/ordererOrganizations/${ORG_DOMAIN}/orderers/orderer.${ORG_DOMAIN}/tls:/var/hyperledger/tls
    - orderer:/var/ledger
    networks:
      - org_network
      - global_network

  peer:
    container_name: peer.${ORG_DOMAIN}
    image: hyperledger/fabric-peer:${FABRIC_IMAGE_TAG}
    command: peer node start
    working_dir: /home/peer/scripts
    depends_on: 
      - orderer
    environment:
      FABRIC_CFG_PATH: /var/hyperledger/config
      FABRIC_LOGGING_SPEC: INFO
      
      CORE_PEER_ID: peer.${ORG_DOMAIN}
      CORE_PEER_ADDRESS: peer.${ORG_DOMAIN}:7051
      CORE_PEER_GOSSIP_EXTERNALENDPOINT: peer.${ORG_DOMAIN}:7051
      CORE_PEER_CHAINCODEADDRESS: peer.${ORG_DOMAIN}:7052
      CORE_PEER_CHAINCODELISTENADDRESS: 0.0.0.0:7052
      CORE_PEER_NETWORKID: ${ORG_DOMAIN}
      CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE: ${ORG_DOMAIN}

      CORE_PEER_MSPCONFIGPATH: /var/hyperledger/msp
      CORE_PEER_LOCALMSPID: ${ORG_PEER_LOCALMSPID}

      CORE_PEER_TLS_ENABLED: "true"
      CORE_PEER_TLS_CERT_FILE: /var/hyperledger/tls/server.crt
      CORE_PEER_TLS_KEY_FILE: /var/hyperledger/tls/server.key
      CORE_PEER_TLS_ROOTCERT_FILE: /var/hyperledger/tls/ca.crt

      CORE_PEER_GOSSIP_USELEADERELECTION: "false"
      CORE_PEER_GOSSIP_ORGLEADER: "true"
    volumes:
      - /var/run/:/var/run/
      - ./scripts/peer:/home/peer/scripts
      - ./configs/nodes/core.yaml:/var/hyperledger/config/core.yaml
      - ./.generated/cc-src:/var/hyperledger/cc-src
      - ./.generated/cc-pkg:/var/hyperledger/cc-pkg
      - ./.generated/channel-artifacts/peer:/var/hyperledger/channel-artifacts
      - ./.generated/crypto/peerOrganizations/${ORG_DOMAIN}/peers/peer.${ORG_DOMAIN}/msp:/var/hyperledger/msp
      - ./.generated/crypto/peerOrganizations/${ORG_DOMAIN}/peers/peer.${ORG_DOMAIN}/tls:/var/hyperledger/tls
      - ./.generated/crypto/peerOrganizations/${ORG_DOMAIN}/users/Admin@${ORG_DOMAIN}/msp:/var/hyperledger/admin/msp
      - ./.generated/crypto/ordererOrganizations/${ORG_DOMAIN}/orderers/orderer.${ORG_DOMAIN}/msp/tlscacerts:/var/hyperledger/orderer-tlscacert
      - peer:/var/hyperledger
    networks:
      - org_network
      - global_network

volumes:
  orderer:
  peer:

networks:
  org_network:
    external: true
    name: ${ORG_NAME}
  global_network:
    external: true
    name: global_network