version: '3.8'

x-orderer-config-override: &orderer_config_override
  ORDERER_GENERAL_LISTENADDRESS: 0.0.0.0

  ORDERER_GENERAL_BOOTSTRAPMETHOD: file
  ORDERER_GENERAL_BOOTSTRAPFILE: /var/hyperledger/genesis-block/medtechchain-genesis.block  

  ORDERER_GENERAL_LOCALMSPDIR: /var/hyperledger/msp
  ORDERER_GENERAL_LOCALMSPID: LifeCareOrdererMSP

  ORDERER_GENERAL_TLS_ENABLED: "true"
  ORDERER_GENERAL_TLS_PRIVATEKEY: /var/hyperledger/tls/server.key
  ORDERER_GENERAL_TLS_CERTIFICATE: /var/hyperledger/tls/server.crt
  ORDERER_GENERAL_TLS_ROOTCAS: "[/var/hyperledger/tls/ca.crt]"  

x-core-config-override: &core_config_override
  CORE_PEER_NETWORKID: lifecare

  CORE_PEER_MSPCONFIGPATH: /var/hyperledger/msp
  CORE_PEER_LOCALMSPID: LifeCarePeerMSP

  CORE_PEER_GOSSIP_USELEADERELECTION: "true"
  CORE_PEER_GOSSIP_ORGLEADER: "false"

  CORE_PEER_TLS_ENABLED: "true"
  CORE_PEER_TLS_CERT_FILE: /var/hyperledger/tls/server.crt
  CORE_PEER_TLS_KEY_FILE: /var/hyperledger/tls/server.key
  CORE_PEER_TLS_ROOTCERT_FILE: /var/hyperledger/tls/ca.crt

  CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE: lifecare

x-peer-defaults: &peer_defaults
    image: hyperledger/fabric-peer:$FABRIC_IMAGE_TAG
    working_dir: /home/peer/scripts
    environment: &peer_env_vars
      FABRIC_CFG_PATH: /var/hyperledger/config
      FABRIC_LOGGING_SPEC: INFO
      <<: *core_config_override
    command: peer node start
    depends_on: 
      - orderer.lifecare.nl
    networks:
      - lifecare
      - tools

services:
  orderer.lifecare.nl:
    container_name: orderer.lifecare.nl
    image: hyperledger/fabric-orderer:$FABRIC_IMAGE_TAG
    environment:
      FABRIC_CFG_PATH: /var/hyperledger/config
      FABRIC_LOGGING_SPEC: INFO
      <<: *orderer_config_override
    command: orderer
    volumes:
    - ./configs/nodes/orderer:/var/hyperledger/config
    - ./.generated/genesis-block:/var/hyperledger/genesis-block
    - ./.generated/crypto/ordererOrganizations/lifecare.nl/orderers/orderer.lifecare.nl/msp:/var/hyperledger/msp
    - ./.generated/crypto/ordererOrganizations/lifecare.nl/orderers/orderer.lifecare.nl/tls:/var/hyperledger/tls
    - orderer.lifecare.nl:/var/ledger
    ports:
      - 10050:7050
    networks:
      - lifecare
      - internet
      - tools

  peer0.lifecare.nl:
    <<: *peer_defaults
    container_name: peer0.lifecare.nl
    environment:
      <<: *peer_env_vars
      CORE_PEER_ID: peer0.lifecare.nl
      CORE_PEER_ADDRESS: "peer0.lifecare.nl:7051"
      CORE_PEER_GOSSIP_BOOTSTRAP: "peer1.lifecare.nl:7051 peer2.lifecare.nl:7051"
    volumes:
      # chaincode docker mount
      - /var/run/:/var/run/

      # peer config
      - ./configs/nodes/peer:/var/hyperledger/config

      # node msp & tls
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer0.lifecare.nl/msp:/var/hyperledger/msp
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer0.lifecare.nl/tls:/var/hyperledger/tls

      # channel artifacts mount
      - ./.generated/channel-artifacts/peer/peer0.lifecare.nl:/var/hyperledger/channel-artifacts

      # orderer tlscacert to create / join the channel
      - ./.generated/crypto/ordererOrganizations/lifecare.nl/orderers/orderer.lifecare.nl/msp/tlscacerts:/var/hyperledger/orderer-tlscacert

      # admin msp to create / join the channel
      - ./.generated/crypto/peerOrganizations/lifecare.nl/users/Admin@lifecare.nl/msp:/var/hyperledger/admin/msp

      # Chaincode package
      - ./.generated/cc-pkg:/var/hyperledger/cc-pkg
      
      # scripts
      - ./scripts/peer:/home/peer/scripts

      # blocks persistance
      - peer0.lifecare.nl:/var/hyperledger

  peer1.lifecare.nl:
    <<: *peer_defaults
    container_name: peer1.lifecare.nl
    environment:
      <<: *peer_env_vars
      CORE_PEER_ID: peer1.lifecare.nl
      CORE_PEER_ADDRESS: "peer1.lifecare.nl:7051"
      CORE_PEER_GOSSIP_BOOTSTRAP: "peer0.lifecare.nl:7051 peer2.lifecare.nl:7051"
    volumes:
      # chaincode docker mount
      - /var/run/:/var/run/

      # peer config
      - ./configs/nodes/peer:/var/hyperledger/config

      # node msp & tls
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer1.lifecare.nl/msp:/var/hyperledger/msp
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer1.lifecare.nl/tls:/var/hyperledger/tls

      # channel artifacts mount
      - ./.generated/channel-artifacts/peer/peer1.lifecare.nl:/var/hyperledger/channel-artifacts

      # orderer tlscacert to create / join the channel
      - ./.generated/crypto/ordererOrganizations/lifecare.nl/orderers/orderer.lifecare.nl/msp/tlscacerts:/var/hyperledger/orderer-tlscacert

      # admin msp to create / join the channel
      - ./.generated/crypto/peerOrganizations/lifecare.nl/users/Admin@lifecare.nl/msp:/var/hyperledger/admin/msp
      
      # Chaincode package
      - ./.generated/cc-pkg:/var/hyperledger/cc-pkg

      # scripts
      - ./scripts/peer:/home/peer/scripts

      # blocks persistance
      - peer1.lifecare.nl:/var/hyperledger

  peer2.lifecare.nl:
    <<: *peer_defaults
    container_name: peer2.lifecare.nl
    environment:
      <<: *peer_env_vars
      CORE_PEER_ID: peer2.lifecare.nl
      CORE_PEER_ADDRESS: "peer2.lifecare.nl:7051"
      CORE_PEER_CHAINCODEADDRESS: "peer2.lifecare.nl:7052"
      CORE_PEER_CHAINCODELISTENADDRESS: "0.0.0.0:7052"
      CORE_PEER_GOSSIP_BOOTSTRAP: "peer0.lifecare.nl:7051 peer1.lifecare.nl:7051"
      CORE_PEER_GOSSIP_EXTERNALENDPOINT: "peer2.lifecare.nl:7051"
    volumes:
      # chaincode docker mount
      - /var/run/:/var/run/

      # peer config
      - ./configs/nodes/peer:/var/hyperledger/config

      # node msp & tls
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer2.lifecare.nl/msp:/var/hyperledger/msp
      - ./.generated/crypto/peerOrganizations/lifecare.nl/peers/peer2.lifecare.nl/tls:/var/hyperledger/tls

      # channel artifacts mount
      - ./.generated/channel-artifacts/peer/peer2.lifecare.nl:/var/hyperledger/channel-artifacts

      # orderer tlscacert to create / join the channel
      - ./.generated/crypto/ordererOrganizations/lifecare.nl/orderers/orderer.lifecare.nl/msp/tlscacerts:/var/hyperledger/orderer-tlscacert

      # admin msp to create / join the channel
      - ./.generated/crypto/peerOrganizations/lifecare.nl/users/Admin@lifecare.nl/msp:/var/hyperledger/admin/msp
      
      # Chaincode package
      - ./.generated/cc-pkg:/var/hyperledger/cc-pkg

      # scripts
      - ./scripts/peer:/home/peer/scripts

      # blocks persistance
      - peer2.lifecare.nl:/var/hyperledger
    networks:
      - lifecare
      - internet
      - tools

volumes:
  orderer.lifecare.nl:
  peer0.lifecare.nl:
  peer1.lifecare.nl:
  peer2.lifecare.nl:

networks:
  lifecare:
    external: true
    name: "lifecare"
  tools:
    external: true
    name: "fabric-tools"
  internet:
    external: true
    name: "internet"